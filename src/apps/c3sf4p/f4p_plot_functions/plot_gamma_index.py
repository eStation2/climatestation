import matplotlib.pyplot as plt
# from inspect import currentframe, getframeinfo
import numpy as np
# from apps.c3sf4p.f4p_utilities.stats_funcions import log_report
from matplotlib.colors import ListedColormap
from scipy import interpolate


def _reshape_cmap(data, n):
    if n is not None:
        r = np.array(data)[:, 0]
        g = np.array(data)[:, 1]
        b = np.array(data)[:, 2]
        x = range(0, len(r))
        x_new = np.linspace(0, len(r), n)

        tck_r = interpolate.splrep(x, r)
        tck_g = interpolate.splrep(x, g)
        tck_b = interpolate.splrep(x, b)

        r2 = interpolate.splev(x_new, tck_r)
        g2 = interpolate.splev(x_new, tck_g)
        b2 = interpolate.splev(x_new, tck_b)

        # normalize the interpolation!
        r2[r2 < 0] = 0
        r2[r2 > 1] = 1
        g2[g2 < 0] = 0
        g2[g2 > 1] = 1
        b2[b2 < 0] = 0
        b2[b2 > 1] = 1

        c_map = np.array([r2, g2, b2]).transpose()
    else:
        c_map = data

    return c_map


def hide_gi(ncolor, shift):
    n = int(ncolor)
    data = [[0.20090956, 0.16744729, 0.53179102],
            [0.21403799, 0.17112469, 0.53823997],
            [0.21734149, 0.17663010, 0.54997171],
            [0.21571253, 0.18298890, 0.56380379],
            [0.21231175, 0.18959745, 0.57792984],
            [0.20901808, 0.19611731, 0.59146926],
            [0.20678779, 0.20239345, 0.60413360],
            [0.20593750, 0.20839217, 0.61598482],
            [0.20636387, 0.21415463, 0.62726490],
            [0.20771126, 0.21976285, 0.63828040],
            [0.20949665, 0.22531558, 0.64932824],
            [0.21120015, 0.23091178, 0.66065219],
            [0.21232769, 0.23663991, 0.67242131],
            [0.21245207, 0.24257173, 0.68472381],
            [0.21123682, 0.24875923, 0.69757098],
            [0.20844732, 0.25523401, 0.71090748],
            [0.20395214, 0.26200818, 0.72462480],
            [0.19771772, 0.26907631, 0.73857604],
            [0.18979824, 0.27641807, 0.75259037],
            [0.18032269, 0.28400104, 0.76648621],
            [0.16948045, 0.29178368, 0.78008266],
            [0.15750634, 0.29971810, 0.79320878],
            [0.14466619, 0.30775269, 0.80571073],
            [0.13124318, 0.31583441, 0.81745670],
            [0.11752562, 0.32391076, 0.82834004],
            [0.10379628, 0.33193142, 0.83828061],
            [0.09032338, 0.33984953, 0.84722473],
            [0.07735341, 0.34762273, 0.85514401],
            [0.06510555, 0.35521384, 0.86203333],
            [0.05376773, 0.36259130, 0.86790813],
            [0.04349424, 0.36972940, 0.87280145],
            [0.03440457, 0.37660832, 0.87676068],
            [0.02658347, 0.38321402, 0.87984436],
            [0.02008196, 0.38953796, 0.88211907],
            [0.01491921, 0.39557681, 0.88365657],
            [0.01108496, 0.40133197, 0.88453121],
            [0.00854256, 0.40680918, 0.88481769],
            [0.00723221, 0.41201793, 0.88458921],
            [0.00707447, 0.41697106, 0.88391592],
            [0.00797389, 0.42168412, 0.88286384],
            [0.00982250, 0.42617498, 0.88149404],
            [0.01250333, 0.43046328, 0.87986213],
            [0.01589367, 0.43456997, 0.87801806],
            [0.01986809, 0.43851690, 0.87600611],
            [0.02430127, 0.44232640, 0.87386510],
            [0.02907041, 0.44602091, 0.87162870],
            [0.03405738, 0.44962266, 0.86932588],
            [0.03915056, 0.45315337, 0.86698139],
            [0.04424628, 0.45663398, 0.86461632],
            [0.04924997, 0.46008441, 0.86224859],
            [0.05407701, 0.46352341, 0.85989349],
            [0.05865329, 0.46696834, 0.85756415],
            [0.06291547, 0.47043507, 0.85527191],
            [0.06681100, 0.47393788, 0.85302672],
            [0.07029801, 0.47748935, 0.85083738],
            [0.07334490, 0.48110035, 0.84871176],
            [0.07592985, 0.48477995, 0.84665693],
            [0.07804017, 0.48853549, 0.84467923],
            [0.07967159, 0.49237253, 0.84278427],
            [0.08082744, 0.49629489, 0.84097691],
            [0.08151779, 0.50030473, 0.83926119],
            [0.08175863, 0.50440257, 0.83764018],
            [0.08157092, 0.50858741, 0.83611591],
            [0.08097980, 0.51285678, 0.83468922],
            [0.08001372, 0.51720686, 0.83335962],
            [0.07870368, 0.52163260, 0.83212521],
            [0.07708249, 0.52612781, 0.83098255],
            [0.07518410, 0.53068530, 0.82992660],
            [0.07304303, 0.53529702, 0.82895072],
            [0.07069380, 0.53995416, 0.82804662],
            [0.06817050, 0.54464733, 0.82720443],
            [0.06550642, 0.54936667, 0.82641279],
            [0.06273374, 0.55410196, 0.82565892],
            [0.05988325, 0.55884281, 0.82492882],
            [0.05698424, 0.56357874, 0.82420743],
            [0.05406432, 0.56829934, 0.82347884],
            [0.05114941, 0.57299435, 0.82272655],
            [0.04826369, 0.57765383, 0.82193368],
            [0.04542966, 0.58226819, 0.82108330],
            [0.04266814, 0.58682836, 0.82015863],
            [0.03999842, 0.59132583, 0.81914338],
            [0.03743836, 0.59575272, 0.81802194],
            [0.03500445, 0.60010190, 0.81677968],
            [0.03271203, 0.60436696, 0.81540317],
            [0.03057536, 0.60854235, 0.81388036],
            [0.02860778, 0.61262333, 0.81220078],
            [0.02682181, 0.61660604, 0.81035566],
            [0.02522933, 0.62048747, 0.80833805],
            [0.02384161, 0.62426550, 0.80614291],
            [0.02266943, 0.62793888, 0.80376709],
            [0.02172319, 0.63150716, 0.80120937],
            [0.02101289, 0.63497074, 0.79847037],
            [0.02054824, 0.63833074, 0.79555254],
            [0.02033864, 0.64158905, 0.79245997],
            [0.02039320, 0.64474818, 0.78919828],
            [0.02072073, 0.64781127, 0.78577447],
            [0.02132968, 0.65078200, 0.78219668],
            [0.02222815, 0.65366450, 0.77847402],
            [0.02342380, 0.65646333, 0.77461633],
            [0.02492382, 0.65918334, 0.77063395],
            [0.02673484, 0.66182965, 0.76653750],
            [0.02886287, 0.66440756, 0.76233762],
            [0.03131322, 0.66692243, 0.75804479],
            [0.03409047, 0.66937970, 0.75366910],
            [0.03719835, 0.67178472, 0.74922004],
            [0.04063971, 0.67414274, 0.74470636],
            [0.04441647, 0.67645885, 0.74013593],
            [0.04852953, 0.67873787, 0.73551557],
            [0.05297883, 0.68098437, 0.73085101],
            [0.05776321, 0.68320255, 0.72614681],
            [0.06288049, 0.68539624, 0.72140633],
            [0.06832743, 0.68756885, 0.71663174],
            [0.07409976, 0.68972335, 0.71182404],
            [0.08019220, 0.69186222, 0.70698314],
            [0.08659850, 0.69398745, 0.70210794],
            [0.09331150, 0.69610053, 0.69719644],
            [0.10032317, 0.69820245, 0.69224590],
            [0.10762472, 0.70029369, 0.68725296],
            [0.11520666, 0.70237421, 0.68221384],
            [0.12305887, 0.70444349, 0.67712450],
            [0.13117074, 0.70650056, 0.67198084],
            [0.13953120, 0.70854396, 0.66677891],
            [0.14812887, 0.71057183, 0.66151502],
            [0.15695216, 0.71258193, 0.65618600],
            [0.16598933, 0.71457163, 0.65078935],
            [0.17522859, 0.71653801, 0.64532334],
            [0.18465820, 0.71847787, 0.63978721],
            [0.19426656, 0.72038774, 0.63418126],
            [0.20404225, 0.72226401, 0.62850690],
            [0.21397410, 0.72410289, 0.62276679],
            [0.22405126, 0.72590051, 0.61696480],
            [0.23426322, 0.72765294, 0.61110603],
            [0.24459986, 0.72935627, 0.60519683],
            [0.25505145, 0.73100660, 0.59924469],
            [0.26560864, 0.73260017, 0.59325821],
            [0.27626249, 0.73413332, 0.58724695],
            [0.28700445, 0.73560258, 0.58122130],
            [0.29782630, 0.73700473, 0.57519237],
            [0.30872014, 0.73833678, 0.56917178],
            [0.31967834, 0.73959605, 0.56317149],
            [0.33069352, 0.74078021, 0.55720359],
            [0.34175842, 0.74188726, 0.55128009],
            [0.35286593, 0.74291561, 0.54541280],
            [0.36400897, 0.74386408, 0.53961304],
            [0.37518045, 0.74473190, 0.53389135],
            [0.38637326, 0.74551874, 0.52825764],
            [0.39758012, 0.74622474, 0.52272064],
            [0.40879362, 0.74685047, 0.51728794],
            [0.42000615, 0.74739694, 0.51196590],
            [0.43120987, 0.74786559, 0.50675946],
            [0.44239672, 0.74825833, 0.50167207],
            [0.45355838, 0.74857742, 0.49670580],
            [0.46468626, 0.74882551, 0.49186096],
            [0.47577158, 0.74900558, 0.48713659],
            [0.48680541, 0.74912099, 0.48253037],
            [0.49777862, 0.74917529, 0.47803826],
            [0.50868204, 0.74917229, 0.47365535],
            [0.51950651, 0.74911598, 0.46937533],
            [0.53024294, 0.74901046, 0.46519122],
            [0.54088247, 0.74885986, 0.46109508],
            [0.55141651, 0.74866842, 0.45707842],
            [0.56183689, 0.74844020, 0.45313270],
            [0.57213602, 0.74817919, 0.44924863],
            [0.58230694, 0.74788922, 0.44541750],
            [0.59234347, 0.74757386, 0.44163082],
            [0.60224042, 0.74723643, 0.43788074],
            [0.61199360, 0.74687983, 0.43415942],
            [0.62159996, 0.74650658, 0.43046041],
            [0.63105774, 0.74611882, 0.42677849],
            [0.64036649, 0.74571811, 0.42310895],
            [0.64952723, 0.74530560, 0.41944863],
            [0.65854240, 0.74488190, 0.41579518],
            [0.66741587, 0.74444710, 0.41214811],
            [0.67615315, 0.74400080, 0.40850735],
            [0.68476111, 0.74354202, 0.40487531],
            [0.69324813, 0.74306939, 0.40125326],
            [0.70162384, 0.74258126, 0.39764500],
            [0.70989912, 0.74207532, 0.39405460],
            [0.71808606, 0.74154930, 0.39048605],
            [0.72619744, 0.74100082, 0.38694405],
            [0.73424699, 0.74042710, 0.38343353],
            [0.74224875, 0.73982560, 0.37995827],
            [0.75021709, 0.73919432, 0.37652151],
            [0.75816636, 0.73853096, 0.37312641],
            [0.76611045, 0.73783444, 0.36977481],
            [0.77406265, 0.73710383, 0.36646518],
            [0.78203535, 0.73633912, 0.36319765],
            [0.79003961, 0.73554182, 0.35996751],
            [0.79808487, 0.73471378, 0.35677098],
            [0.80617841, 0.73385865, 0.35359855],
            [0.81432567, 0.73298178, 0.35044293],
            [0.82252935, 0.73208969, 0.34729207],
            [0.83078924, 0.73119066, 0.34413148],
            [0.83910212, 0.73029452, 0.34094619],
            [0.84746172, 0.72941368, 0.33772155],
            [0.85585841, 0.72856148, 0.33443826],
            [0.86427871, 0.72775398, 0.33107936],
            [0.87270634, 0.72700792, 0.32762453],
            [0.88112076, 0.72634258, 0.32405540],
            [0.88949887, 0.72577822, 0.32035275],
            [0.89781334, 0.72533612, 0.31650124],
            [0.90603482, 0.72503963, 0.31248638],
            [0.91413068, 0.72491179, 0.30829502],
            [0.92206590, 0.72497576, 0.30391667],
            [0.92980426, 0.72525563, 0.29933935],
            [0.93730694, 0.72577358, 0.29456982],
            [0.94453561, 0.72655256, 0.28960236],
            [0.95145060, 0.72761187, 0.28444496],
            [0.95801315, 0.72897104, 0.27910808],
            [0.96418556, 0.73064539, 0.27360577],
            [0.96993212, 0.73264759, 0.26795951],
            [0.97521887, 0.73498734, 0.26218638],
            [0.98001654, 0.73766935, 0.25631651],
            [0.98429814, 0.74069330, 0.25038274],
            [0.98804259, 0.74405784, 0.24441356],
            [0.99123330, 0.74775274, 0.23844452],
            [0.99385990, 0.75176542, 0.23251652],
            [0.99591791, 0.75607526, 0.22665635],
            [0.99741021, 0.76066012, 0.22089747],
            [0.99834551, 0.76549174, 0.21527279],
            [0.99873989, 0.77053956, 0.20981352],
            [0.99861776, 0.77576619, 0.20453298],
            [0.99800780, 0.78113567, 0.19945597],
            [0.99694740, 0.78660997, 0.19458991],
            [0.99547974, 0.79214824, 0.18993482],
            [0.99365196, 0.79771375, 0.18549503],
            [0.99151764, 0.80326867, 0.18122993],
            [0.98913344, 0.80878347, 0.17715714],
            [0.98655763, 0.81423272, 0.17323446],
            [0.98385092, 0.81959206, 0.16942729],
            [0.98107516, 0.82485787, 0.16569463],
            [0.97828903, 0.83002000, 0.16202495],
            [0.97555080, 0.83508953, 0.15833645],
            [0.97291362, 0.84008551, 0.15463109],
            [0.97042524, 0.84503273, 0.15084106],
            [0.96812829, 0.84996747, 0.14696445],
            [0.96605810, 0.85494371, 0.14296985],
            [0.96424193, 0.86000253, 0.13886848],
            [0.96269917, 0.86520211, 0.13462411],
            [0.96143843, 0.87059485, 0.13026393],
            [0.96046335, 0.87623049, 0.12580708],
            [0.95977061, 0.88214877, 0.12128558],
            [0.95934819, 0.88837946, 0.11672980],
            [0.95917601, 0.89492175, 0.11217361],
            [0.95924215, 0.90175557, 0.10762740],
            [0.95952400, 0.90883561, 0.10314682],
            [0.96000915, 0.91609967, 0.09868592],
            [0.96068829, 0.92345134, 0.09426749],
            [0.96156778, 0.93077786, 0.08982912],
            [0.96265942, 0.93798453, 0.08525120],
            [0.96400286, 0.94500797, 0.08050216],
            [0.96565070, 0.95183907, 0.07554599],
            [0.96768014, 0.95865884, 0.07020238],
            [0.97019891, 0.96582792, 0.06464402],
            [0.97332521, 0.97404955, 0.05909638],
            [0.97720984, 0.98456943, 0.05418880]]
    c_map = _reshape_cmap(data, n)
    cmap2 = np.zeros([n + shift, 3])
    cmap2[0:n, :] = c_map
    cmap2[n:, :] = [1, 0, 0]  # add red on top
    return ListedColormap(cmap2)


def graphical_render(data, zone_coord, ngi, save_name, title=None):

    if title is None:
        title = ''

    step = (zone_coord[1] - zone_coord[0]) / data.shape[0]
    # print step
    lat1 = zone_coord[0] + step / 2.  # south
    lat2 = zone_coord[1] + step / 2.  # north
    lon1 = zone_coord[2] + step / 2.  # west
    lon2 = zone_coord[3] + step / 2.  # east

    c_map = hide_gi(11, 1)
    cb_ticks = np.linspace(0., 1.1, 13)
    cb_tick_labels = ['0.', '0.1', '0.2', '0.3', '0.4', '0.5', '0.6', '0.7', '0.8', '0.9', '1.', '$\gamma$ > 1']
    val_max = 1.1
    val_min = 0.

    plt.figure()
    plt.imshow(data, cmap=c_map, interpolation='none', vmax=val_min, vmin=val_min)
    cb = plt.colorbar(ticks=cb_ticks)
    cb.ax.set_yticklabels(cb_tick_labels)
    cb.set_label('Gamma Index', fontsize=12)
    cb.ax.tick_params(labelsize=12)
    plt.title(str(title), fontsize=12)

    props = dict(boxstyle='square', facecolor=[1, 0.96, 0.89], alpha=0.8)
    gi_txt = 'NGI = ' + str(ngi) + '%'

    ix = lon1 + (lon2 - lon1) / 72
    iy = lat1 + (lat2 - lat1) / 7.2
    plt.text(ix, iy, gi_txt, fontsize=12, verticalalignment='top', bbox=props)

    plt.savefig(save_name)
